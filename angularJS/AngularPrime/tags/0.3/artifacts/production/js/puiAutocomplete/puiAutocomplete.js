angular.module("angular.prime").directive("puiAutocomplete",function(){return{restrict:"A",require:"?ngModel",link:function(a,b,c,e){if(e&&"TEXTAREA"!==b[0].nodeName){var d=a.$eval(c.puiAutocomplete)||{},f=angular.isFunction(d),g=angular.isArray(d),h=null;if(f||g)h=d,d={};else{d.dropdown=void 0!==d.dropdown?d.dropdown:!1;d.multiple=void 0!==d.multiple?d.multiple:!1;d.forceSelection=void 0!==d.forceSelection?d.forceSelection:!1;d.delay=d.delay||300;d.minQueryLength=d.minQueryLength||1;d.scrollHeight=
d.scrollHeight||200;d.effectSpeed=d.effectSpeed||"normal";d.caseSensitive=void 0!==d.caseSensitive?d.caseSensitive:!1;if(!d.completeSource)throw"completeSource property required for auto complete functionality";h=d.completeSource}$(function(){b.puiautocomplete({dropdown:d.dropdown,multiple:d.multiple,completeSource:h,forceSelection:d.forceSelection,delay:d.delay,minQueryLength:d.minQueryLength,scrollHeight:d.scrollHeight,effectSpeed:d.effectSpeed,caseSensitive:d.caseSensitive,effect:d.effect,effectOptions:d.effectOptions});
var f={read:function(c,f){$(function(){if(d.multiple)if(f)a.safeApply(function(){d.multipleValues.push(c);e.$setViewValue("")});else{var g=d.multipleValues.indexOf(c);a.safeApply(function(){d.multipleValues.splice(g,1)})}else a.safeApply(function(){e.$setViewValue(b.val())})})}};b.bind("puiautocompleteselect",function(a,b){f.read(d.multiple?b:null,!0);d.callback&&d.callback(b)});b.bind("puiautocompleteunselect",function(a,b){f.read(d.multiple?b:null,!1)});c.ngDisabled&&a.$watch(c.ngDisabled,function(a){!1===
a?$(function(){b.puiautocomplete("enable")}):$(function(){b.puiautocomplete("disable")})})})}}}});$(function(){$.widget("primeui.puiautocomplete",{options:{delay:300,minQueryLength:1,multiple:!1,dropdown:!1,scrollHeight:200,forceSelection:!1,effect:null,effectOptions:{},effectSpeed:"normal",content:null,caseSensitive:!1},_create:function(){this.element.puiinputtext();this.panel=$('<div class="pui-autocomplete-panel ui-widget-content ui-corner-all ui-helper-hidden pui-shadow"></div>').appendTo("body");this.options.multiple?(this.element.wrap('<ul class="pui-autocomplete-multiple ui-widget pui-inputtext ui-state-default ui-corner-all"><li class="pui-autocomplete-input-token"></li></ul>'),
this.inputContainer=this.element.parent(),this.multiContainer=this.inputContainer.parent()):this.options.dropdown&&(this.dropdown=$('<button type="button" class="pui-button ui-widget ui-state-default ui-corner-right pui-button-icon-only"><span class="pui-button-icon-primary ui-icon ui-icon-triangle-1-s"></span><span class="pui-button-text">&nbsp;</span></button>').insertAfter(this.element),this.element.removeClass("ui-corner-all").addClass("ui-corner-left"));this._bindKeyEvents();this._bindEvents()},
_bindEvents:function(){var a=this;if(this.options.dropdown)this.dropdown.on("hover.puiautocomplete",function(){a.element.prop("disabled")||a.dropdown.toggleClass("ui-state-hover")}).on("mousedown.puiautocomplete",function(){a.element.prop("disabled")||a.dropdown.addClass("ui-state-active")}).on("mouseup.puiautocomplete",function(){a.element.prop("disabled")||(a.dropdown.removeClass("ui-state-active"),a.search(""),a.element.focus())}).on("focus.puiautocomplete",function(){a.dropdown.addClass("ui-state-focus")}).on("blur.puiautocomplete",
function(){a.dropdown.removeClass("ui-state-focus")}).on("keydown.puiautocomplete",function(b){var c=$.ui.keyCode;if(b.which==c.ENTER||b.which==c.NUMPAD_ENTER)a.search(""),a.input.focus(),b.preventDefault()});this.options.multiple&&(this.multiContainer.on("hover.puiautocomplete",function(){$(this).toggleClass("ui-state-hover")}).on("click.puiautocomplete",function(){a.element.trigger("focus")}),this.element.on("focus.pui-autocomplete",function(){a.multiContainer.addClass("ui-state-focus")}).on("blur.pui-autocomplete",
function(){a.multiContainer.removeClass("ui-state-focus")}));this.options.forceSelection&&(this.cachedResults=[this.element.val()],this.element.on("blur.puiautocomplete",function(){for(var b=a.element.val(),c=false,e=0;e<a.cachedResults.length;e++)if(a.cachedResults[e]==b){c=true;break}if(!c){a.element.val("");a._trigger("select",null,"")}}));$(document.body).bind("mousedown.puiautocomplete",function(b){if(!a.panel.is(":hidden")&&b.target!==a.element.get(0)){var c=a.panel.offset();(b.pageX<c.left||
b.pageX>c.left+a.panel.width()||b.pageY<c.top||b.pageY>c.top+a.panel.height())&&a.hide()}});$(window).bind("resize."+this.element.id,function(){a.panel.is(":visible")&&a._alignPanel()})},_bindKeyEvents:function(){var a=this;this.element.on("keyup.puiautocomplete",function(b){var c=$.ui.keyCode,b=b.which,e=!0;if(b==c.UP||b==c.LEFT||b==c.DOWN||b==c.RIGHT||b==c.TAB||b==c.SHIFT||b==c.ENTER||b==c.NUMPAD_ENTER)e=!1;if(e){var d=a.element.val();d.length||a.hide();d.length>=a.options.minQueryLength&&(a.timeout&&
clearTimeout(a.timeout),a.timeout=setTimeout(function(){a.search(d)},a.options.delay))}}).on("keydown.puiautocomplete",function(b){if(a.panel.is(":visible")){var c=$.ui.keyCode,e=a.items.filter(".ui-state-highlight");switch(b.which){case c.UP:case c.LEFT:c=e.prev();1==c.length&&(e.removeClass("ui-state-highlight"),c.addClass("ui-state-highlight"),a.options.scrollHeight&&PUI.scrollInView(a.panel,c));b.preventDefault();break;case c.DOWN:case c.RIGHT:c=e.next();1==c.length&&(e.removeClass("ui-state-highlight"),
c.addClass("ui-state-highlight"),a.options.scrollHeight&&PUI.scrollInView(a.panel,c));b.preventDefault();break;case c.ENTER:case c.NUMPAD_ENTER:e.trigger("click");b.preventDefault();break;case c.TAB:e.trigger("click"),a.hide()}}})},_bindDynamicEvents:function(){var a=this;this.items.on("mouseover.puiautocomplete",function(){var b=$(this);b.hasClass("ui-state-highlight")||(a.items.filter(".ui-state-highlight").removeClass("ui-state-highlight"),b.addClass("ui-state-highlight"))}).on("click.puiautocomplete",
function(b){var c=$(this);if(a.options.multiple){var e;e='<li class="pui-autocomplete-token ui-state-active ui-corner-all ui-helper-hidden"><span class="pui-autocomplete-token-icon ui-icon ui-icon-close" />'+('<span class="pui-autocomplete-token-label">'+c.data("label")+"</span></li>");$(e).data(c.data()).insertBefore(a.inputContainer).fadeIn().children(".pui-autocomplete-token-icon").on("click.pui-autocomplete",function(b){var c=$(this).parent();a._removeItem(c);a._trigger("unselect",b,c.data("label"))});
a.element.val("").trigger("focus")}else a.element.val(c.data("label")).focus();a._trigger("select",b,c.data("label"));a.hide()})},search:function(a){this.query=this.options.caseSensitive?a:a.toLowerCase();var b={query:this.query};if(this.options.completeSource)if($.isArray(this.options.completeSource)){for(var b=this.options.completeSource,c=[],a=""===$.trim(a),e=0;e<b.length;e++){var d=b[e],f=d.label||d;this.options.caseSensitive||(f=f.toLowerCase());(a||0===f.indexOf(this.query))&&c.push({label:b[e],
value:d})}this._handleData(c)}else this.options.completeSource.call(this,b,this._handleData)},_handleData:function(a){var b=this;this.panel.html("");this.listContainer=$('<ul class="pui-autocomplete-items pui-autocomplete-list ui-widget-content ui-widget ui-corner-all ui-helper-reset"></ul>').appendTo(this.panel);for(var c=0;c<a.length;c++){var e=$('<li class="pui-autocomplete-item pui-autocomplete-list-item ui-corner-all"></li>');e.data(a[c]);this.options.content?e.html(this.options.content.call(this,
a[c])):e.text(a[c].label);this.listContainer.append(e)}this.items=this.listContainer.children(".pui-autocomplete-item");this._bindDynamicEvents();0<this.items.length?(c=b.items.eq(0),e=this.panel.is(":hidden"),c.addClass("ui-state-highlight"),0<b.query.length&&!b.options.content&&b.items.each(function(){var a=$(this),c=a.html(),e=RegExp(PUI.escapeRegExp(b.query),"gi"),c=c.replace(e,'<span class="pui-autocomplete-query">$&</span>');a.html(c)}),this.options.forceSelection&&(this.cachedResults=[],$.each(a,
function(a,c){b.cachedResults.push(c.label)})),b.options.scrollHeight&&((e?b.panel.height():b.panel.children().height())>b.options.scrollHeight?b.panel.height(b.options.scrollHeight):b.panel.css("height","auto")),e?b.show():b._alignPanel()):this.panel.hide()},show:function(){this._alignPanel();this.options.effect?this.panel.show(this.options.effect,{},this.options.effectSpeed):this.panel.show()},hide:function(){this.panel.hide();this.panel.css("height","auto")},_removeItem:function(a){a.fadeOut("fast",
function(){$(this).remove()})},_alignPanel:function(){var a=null;if(this.options.multiple)a=this.multiContainer.innerWidth()-(this.element.position().left-this.multiContainer.position().left);else{this.panel.is(":visible")?a=this.panel.children(".pui-autocomplete-items").outerWidth():(this.panel.css({visibility:"hidden",display:"block"}),a=this.panel.children(".pui-autocomplete-items").outerWidth(),this.panel.css({visibility:"visible",display:"none"}));var b=this.element.outerWidth();a<b&&(a=b)}this.panel.css({left:"",
top:"",width:a,"z-index":++PUI.zindex}).position({my:"left top",at:"left bottom",of:this.element})},_unbindEvents:function(){this.options.dropdown&&this.dropdown.off()},enable:function(){this._bindEvents();this.options.dropdown&&this.dropdown.removeClass("ui-state-disabled")},disable:function(){this._unbindEvents();this.options.dropdown&&this.dropdown.addClass("ui-state-disabled")}})});